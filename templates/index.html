<!DOCTYPE html>
<html>
<head>
    <title>Tic-Tac-Toe AI</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f4f6fb;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; margin: 0;
        }
        h1 { color: #34495e; margin-top: 32px; }
        #container {
            position: relative;
            display: inline-block;
            margin: 24px 0 0 0;
        }
        #board {
            display: grid;
            grid-template-columns: repeat(3, 80px);
            grid-gap: 10px;
            background: #e1ecf4;
            padding: 20px;
            border-radius: 22px;
            box-shadow: 0 8px 24px #3332;
        }
        .cell {
            width: 80px; height: 80px;
            font-size: 2.4em; background: #fff;
            border: 3px solid #59abe3;
            border-radius: 13px; cursor: pointer; color: #2980b9;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.15s, transform 0.12s, color 0.12s;
        }
        .cell.x { color: #2980b9;}
        .cell.o { color: #ff6f61;}
        .cell.animate { animation: pop .18s;}
        @keyframes pop {
            0% { transform: scale(1);}
            70% { transform: scale(1.26);}
            100% { transform: scale(1);}
        }
        .cell:disabled, .cell.disabled {
            background: #f7f6f2; color: #bbb; cursor: not-allowed;
        }
        #status {
            margin: 24px 0 0 0;
            font-size: 1.2em; min-height: 28px;
        }
        .btn {
            padding: 12px 26px; font-size: 1em;
            border-radius: 10px; background: #2980b9; color: #fff;
            border: none; margin-top: 22px; transition: background 0.2s;
            box-shadow: 1px 2px 8px #294E6322;
        }
        .btn:hover { background: #185886;}
        #win-line {
            position: absolute;
            top: 0; left: 0;
            pointer-events: none;
            z-index: 10;
        }
        /* Responsive */
        @media (max-width: 600px) {
          #container, #board, #win-line { width: 180px; height: 180px;}
          .cell { width: 50px; height: 50px; font-size: 1.3em;}
        }
    </style>
</head>
<body>
    <h1>Tic-Tac-Toe vs AI</h1>
    <div id="status"></div>
    <div id="container">
        <div id="board"></div>
        <svg id="win-line"></svg>
    </div>
    <button class="btn" onclick="restartGame()">Restart</button>

<script>
(() => {
    let board = {{ board|tojson|safe }};
    let message = {{ message|tojson|safe }};
    let winningCombo = {{ winning_combo|tojson|safe }};
    let gameOver = false;

    const boardDiv = document.getElementById('board');
    const statusDiv = document.getElementById('status');
    const winLineSvg = document.getElementById('win-line');

    function getBoardDimensions() {
        const cell = 80, gap = 10, pad = 20;
        const size = 3*cell + 2*gap + 2*pad;
        return {cell, gap, pad, size};
    }

    function getCellCenters() {
        const {cell, gap, pad} = getBoardDimensions();
        let centers = [];
        for(let row=0; row<3; row++) {
            for(let col=0; col<3; col++) {
                let x = pad + col * (cell + gap) + cell / 2;
                let y = pad + row * (cell + gap) + cell / 2;
                centers.push([x, y]);
            }
        }
        return centers;
    }

    function renderBoard() {
        boardDiv.innerHTML = '';
        const {size} = getBoardDimensions();
        winLineSvg.setAttribute('width', size);
        winLineSvg.setAttribute('height', size);
        winLineSvg.innerHTML = '';

        for (let i = 0; i < 9; i++) {
            const btn = document.createElement('button');
            btn.className = 'cell';
            if (board[i] === 'X') btn.classList.add('x');
            if (board[i] === 'O') btn.classList.add('o');
            btn.innerHTML = (board[i] === ' ') ? '' : board[i];
            btn.disabled = board[i] !== ' ' || gameOver;
            btn.onclick = () => handleMove(i);
            boardDiv.appendChild(btn);
        }
        if (winningCombo && winningCombo.length === 3) {
            drawWinningLine(winningCombo);
        }
    }

    function drawWinningLine(combo) {
        const {cell, gap, pad} = getBoardDimensions();
        let startX, startY, endX, endY;
        const key = combo.join();

        if (key === '0,1,2' || key === '3,4,5' || key === '6,7,8') {
            // Horizontal
            const row = Math.floor(combo[0] / 3);
            startX = pad + cell / 2;
            endX = pad + 2 * (cell + gap) + cell / 2;
            startY = endY = pad + row * (cell + gap) + cell / 2;
        } else if (key === '0,3,6' || key === '1,4,7' || key === '2,5,8') {
            // Vertical
            const col = combo[0] % 3;
            startY = pad + cell / 2;
            endY = pad + 2 * (cell + gap) + cell / 2;
            startX = endX = pad + col * (cell + gap) + cell / 2;
        } else if (key === '0,4,8') {
            // Diagonal TL-BR
            startX = startY = pad + cell / 2;
            endX = endY = pad + 2 * (cell + gap) + cell / 2;
        } else if (key === '2,4,6') {
            // Diagonal TR-BL
            startX = pad + 2 * (cell + gap) + cell / 2;
            startY = pad + cell / 2;
            endX = pad + cell / 2;
            endY = pad + 2 * (cell + gap) + cell / 2;
        } else {
            const centers = getCellCenters();
            [startX, startY] = centers[combo[0]];
            [endX, endY] = centers[combo];
        }

        winLineSvg.innerHTML = `<line x1="${startX}" y1="${startY}" x2="${endX}" y2="${endY}" stroke="#ffb366" stroke-width="15" stroke-linecap="round">
          <animate attributeName="x2" from="${startX}" to="${endX}" dur="0.38s" fill="freeze" />
          <animate attributeName="y2" from="${startY}" to="${endY}" dur="0.38s" fill="freeze" />
        </line>`;
    }

    async function handleMove(i) {
        if (gameOver) return;
        const cellBtn = boardDiv.children[i];
        cellBtn.classList.add('animate');
        await sleep(100);
        const resp = await fetch('/move', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ move: i })
        });
        const data = await resp.json();
        board = data.board;
        message = data.message;
        winningCombo = data.winning_combo;
        gameOver = !!message;
        renderBoard();
        updateStatus();
    }

    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    function updateStatus() {
        if (!message) {
            let xCount = board.filter(x => x === 'X').length;
            let oCount = board.filter(x => x === 'O').length;
            if (xCount === oCount) statusDiv.textContent = "Your turn!";
            else statusDiv.textContent = "AI is thinking...";
        } else {
            statusDiv.innerHTML = message + "<br><span style='color:#888; font-size:0.96em;'>Don't worry, you can beat the AI if you try again!</span>";
        }
    }

    window.restartGame = () => {
        fetch('/reset', { method: 'POST' })
            .then(resp => resp.json())
            .then(data => {
                board = data.board;
                message = null;
                gameOver = false;
                winningCombo = [];
                renderBoard();
                updateStatus();
            });
    };

    boardDiv.addEventListener('click', e => {
        let xCount = board.filter(x => x === 'X').length;
        let oCount = board.filter(x => x === 'O').length;
        if (xCount !== oCount && !message) e.preventDefault();
    });

    renderBoard();
    updateStatus();
})();
</script>
</body>
</html>
